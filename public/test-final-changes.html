<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Final Changes Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="test-container" class="p-6 bg-gray-100 min-h-screen">
        <h1 class="text-2xl font-bold mb-6">Final Changes Test</h1>
        <div id="test-output" class="space-y-4"></div>
        <div id="flashcard-container" class="mt-6"></div>
    </div>

    <!-- Load core dependencies -->
    <script src="/static/review-system.js"></script>
    <script src="/static/learning-mode-base.js"></script>
    <script src="/static/learning-mode-manager.js"></script>
    <script src="/static/modes/flashcard-mode.js"></script>
    <script src="/static/modes/flashcard-mode-jules.js"></script>

    <script>
        const testOutput = document.getElementById('test-output');

        function addResult(test, status, message) {
            const div = document.createElement('div');
            div.className = `p-3 rounded ${status === 'pass' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
            div.innerHTML = `
                <strong>${test}:</strong>
                <span class="font-mono">${status.toUpperCase()}</span>
                <br><small>${message}</small>
            `;
            testOutput.appendChild(div);
        }

        async function runTests() {
            // Fetch the main page to inspect its DOM
            const response = await fetch('/');
            const html = await response.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');

            // Test 1: Verify the "Interactive Examination" card is NOT on the main page
            try {
                const card = doc.querySelector('.featured-mode-card[data-mode="interactive-examination"]');
                if (!card) {
                    addResult('Main Page UI', 'pass', 'The "Interactive Examination" card has been successfully removed from the main page.');
                } else {
                    addResult('Main Page UI', 'fail', 'The "Interactive Examination" card is still present on the main page.');
                }
            } catch (e) {
                addResult('Main Page UI', 'fail', `Error: ${e.message}`);
            }

            // Test 2: Verify the "Interactive Examination" mode is in the side menu filters
            try {
                const sideMenuScript = Array.from(doc.querySelectorAll('script')).find(s => s.textContent.includes('SideMenuFilters'));
                if (sideMenuScript) {
                    const scriptContent = sideMenuScript.textContent;
                    if (scriptContent.includes(`id: 'interactive-examination'`)) {
                        addResult('Side Menu Filters', 'pass', 'The "Interactive Examination" mode is present in the side menu filters script.');
                    } else {
                        addResult('Side Menu Filters', 'fail', 'The "Interactive Examination" mode is NOT present in the side menu filters script.');
                    }
                } else {
                    addResult('Side Menu Filters', 'fail', 'Could not find the SideMenuFilters script.');
                }
            } catch (e) {
                addResult('Side Menu Filters', 'fail', `Error: ${e.message}`);
            }

            // Test 3: Verify mode registrations
            if (!window.learningModeManager) {
                addResult('Mode Registration', 'fail', 'LearningModeManager not found');
                return;
            }
            const originalMode = window.learningModeManager.getMode('flashcard');
            const julesMode = window.learningModeManager.getMode('interactive-examination');
            if (originalMode && julesMode) {
                addResult('Mode Registration', 'pass', 'Both original and new modes are registered.');
            } else {
                addResult('Mode Registration', 'fail', `Original mode: ${!!originalMode}, New mode: ${!!julesMode}`);
            }

            // Test 4: Test review system integration
            let reviewSystemCalled = false;
            let lastCallParams = {};
            window.reviewSystem.updateWordReview = (wordId, isCorrect) => {
                reviewSystemCalled = true;
                lastCallParams = { wordId, isCorrect };
            };

            const sampleData = {
                words: [
                    { id: 1, turkish: 'Merhaba', arabic: 'Ù…Ø±Ø­Ø¨Ø§', emoji: 'ðŸ‘‹' },
                    { id: 2, turkish: 'TeÅŸekkÃ¼r ederim', arabic: 'Ø´ÙƒØ±Ø§ Ù„Ùƒ', emoji: 'â¤ï¸' },
                    { id: 3, turkish: 'LÃ¼tfen', arabic: 'Ù…Ù† ÙØ¶Ù„Ùƒ', emoji: 'ðŸ™' },
                    { id: 4, turkish: 'Su', arabic: 'Ù…Ø§Ø¡', emoji: 'ðŸ’§' },
                ],
                category: 'greetings'
            };
            const container = document.getElementById('flashcard-container');
            const flashcardMode = new FlashcardModeJules({ container: container, data: sampleData });
            await flashcardMode.init();

            // Simulate correct answer
            const correctWord = flashcardMode.getCurrentWord();
            const correctOption = document.querySelector(`.flashcard-jules-option[data-word-id='${correctWord.id}']`);
            correctOption.click();
            await new Promise(resolve => setTimeout(resolve, 100));

            if (reviewSystemCalled && lastCallParams.wordId == correctWord.id && lastCallParams.isCorrect === true) {
                addResult('Review System (Correct)', 'pass', 'Review system called correctly for a correct answer.');
            } else {
                addResult('Review System (Correct)', 'fail', 'Review system not called correctly for a correct answer.');
            }

            // Reset for next test
            reviewSystemCalled = false;
            lastCallParams = {};

            // Simulate incorrect answer
            flashcardMode.currentIndex = 1;
            flashcardMode.render();
            const incorrectWord = flashcardMode.getCurrentWord();
            const incorrectOption = document.querySelector(`.flashcard-jules-option[data-word-id='${incorrectWord.id === 1 ? 2 : 1}']`);
            incorrectOption.click();
            await new Promise(resolve => setTimeout(resolve, 100));

            if (reviewSystemCalled && lastCallParams.wordId == incorrectWord.id && lastCallParams.isCorrect === false) {
                addResult('Review System (Incorrect)', 'pass', 'Review system called correctly for an incorrect answer.');
            } else {
                addResult('Review System (Incorrect)', 'fail', 'Review system not called correctly for an incorrect answer.');
            }
        }

        document.addEventListener('DOMContentLoaded', runTests);
    </script>
</body>
</html>
