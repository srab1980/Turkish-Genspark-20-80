<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Fixed Session Progression - Turkish Learning App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Arial', sans-serif; }
        .test-section {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            background: #f9fafb;
        }
        .success { border-color: #10b981; background-color: #ecfdf5; }
        .error { border-color: #ef4444; background-color: #fef2f2; }
        .warning { border-color: #f59e0b; background-color: #fffbeb; }
        .info { border-color: #3b82f6; background-color: #eff6ff; }
        .loading {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 2s linear infinite;
            display: inline-block;
            margin-left: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .console-output {
            background: #1f2937;
            color: #f9fafb;
            padding: 1rem;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body class="bg-gray-100 p-4">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-6">üß™ Session Progression Fix Test</h1>
        <p class="text-gray-600 mb-4">This test verifies that the infinite loading issue in session progression has been resolved.</p>
        
        <div class="test-section info">
            <h2 class="text-xl font-bold mb-3">üìã Test Overview</h2>
            <p><strong>Issue Fixed:</strong> "Start Next Session" button was showing infinite loading screen</p>
            <p><strong>Root Cause:</strong> Recursive self-call in startNewFlashcardSession function causing infinite loop</p>
            <p><strong>Solution:</strong> Simplified function with linear async/await pattern and proper error handling</p>
        </div>

        <div class="test-section">
            <h2 class="text-xl font-bold mb-3">üéØ Test 1: Session ID Generation</h2>
            <button id="test-session-ids" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                Test Session ID Generation
            </button>
            <div id="session-id-results" class="mt-3"></div>
        </div>

        <div class="test-section">
            <h2 class="text-xl font-bold mb-3">üöÄ Test 2: New Session Function</h2>
            <p class="text-sm text-gray-600 mb-2">Test the simplified startNewFlashcardSession function</p>
            <div class="flex gap-2 mb-3">
                <button id="test-new-session" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                    Test New Session (Greetings)
                </button>
                <button id="test-specific-session" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                    Test Specific Session ID
                </button>
            </div>
            <div id="new-session-results" class="mt-3"></div>
        </div>

        <div class="test-section">
            <h2 class="text-xl font-bold mb-3">üîÑ Test 3: Session Progression Simulation</h2>
            <p class="text-sm text-gray-600 mb-2">Simulate the exact scenario that was causing infinite loading</p>
            <button id="simulate-progression" class="bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600">
                Simulate Session Progression
            </button>
            <div id="progression-results" class="mt-3"></div>
        </div>

        <div class="test-section">
            <h2 class="text-xl font-bold mb-3">üìä Test 4: Real Integration Test</h2>
            <p class="text-sm text-gray-600 mb-2">Load the actual app and test session progression</p>
            <button id="integration-test" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                Run Integration Test
            </button>
            <div id="integration-results" class="mt-3"></div>
        </div>

        <div class="test-section">
            <h2 class="text-xl font-bold mb-3">üñ•Ô∏è Console Output</h2>
            <div id="console-output" class="console-output">
                Test console output will appear here...
            </div>
            <button id="clear-console" class="mt-2 bg-gray-500 text-white px-3 py-1 rounded text-sm">
                Clear Console
            </button>
        </div>
    </div>

    <script>
        // Console capture
        const consoleDiv = document.getElementById('console-output');
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;

        function addToConsole(message, type = 'log') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '‚ùå' : type === 'warn' ? '‚ö†Ô∏è' : 'üí¨';
            consoleDiv.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }

        console.log = (...args) => {
            originalConsoleLog.apply(console, args);
            addToConsole(args.join(' '), 'log');
        };

        console.error = (...args) => {
            originalConsoleError.apply(console, args);
            addToConsole(args.join(' '), 'error');
        };

        console.warn = (...args) => {
            originalConsoleWarn.apply(console, args);
            addToConsole(args.join(' '), 'warn');
        };

        document.getElementById('clear-console').addEventListener('click', () => {
            consoleDiv.textContent = '';
        });

        // Test functions
        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="p-3 rounded ${type === 'success' ? 'bg-green-100 text-green-800' : type === 'error' ? 'bg-red-100 text-red-800' : type === 'warning' ? 'bg-yellow-100 text-yellow-800' : 'bg-blue-100 text-blue-800'}">${message}</div>`;
        }

        function showLoading(elementId, message) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="p-3 rounded bg-gray-100 text-gray-800">${message} <div class="loading"></div></div>`;
        }

        // Test 1: Session ID Generation
        document.getElementById('test-session-ids').addEventListener('click', async () => {
            console.log('üß™ Testing session ID generation...');
            showLoading('session-id-results', 'Testing session ID formats...');
            
            try {
                // Test various session ID formats
                const tests = [
                    { categoryId: 'greetings', sessionNumber: 1, expected: 'greetings_session_1' },
                    { categoryId: 'health', sessionNumber: 2, expected: 'health_session_2' },
                    { categoryId: 'food', sessionNumber: 3, expected: 'food_session_3' },
                    { categoryId: 'family', sessionNumber: 4, expected: 'family_session_4' }
                ];
                
                let results = [];
                for (const test of tests) {
                    const generated = test.categoryId + '_session_' + test.sessionNumber;
                    const matches = generated === test.expected;
                    results.push(`${matches ? '‚úÖ' : '‚ùå'} ${test.categoryId} session ${test.sessionNumber}: ${generated}`);
                    console.log(`Session ID test: ${generated} ${matches ? 'PASS' : 'FAIL'}`);
                }
                
                showResult('session-id-results', `<strong>Session ID Generation Test Results:</strong><br>${results.join('<br>')}`, 'success');
            } catch (error) {
                console.error('Session ID test failed:', error);
                showResult('session-id-results', `‚ùå Test failed: ${error.message}`, 'error');
            }
        });

        // Test 2: New Session Function
        document.getElementById('test-new-session').addEventListener('click', async () => {
            console.log('üß™ Testing startNewFlashcardSession function...');
            showLoading('new-session-results', 'Testing session function...');
            
            try {
                // Check if function exists
                if (typeof window.startNewFlashcardSession !== 'function') {
                    throw new Error('startNewFlashcardSession function not available');
                }
                
                console.log('‚úÖ Function exists, testing with greetings category...');
                
                const startTime = Date.now();
                const result = await Promise.race([
                    window.startNewFlashcardSession({ categoryId: 'greetings', sessionNumber: 1 }),
                    new Promise((_, reject) => setTimeout(() => reject(new Error('Function timeout after 10 seconds')), 10000))
                ]);
                
                const duration = Date.now() - startTime;
                console.log(`Function completed in ${duration}ms with result:`, result);
                
                showResult('new-session-results', 
                    `‚úÖ <strong>Function Test PASSED</strong><br>
                    ‚Ä¢ Function exists: ‚úÖ<br>
                    ‚Ä¢ Execution time: ${duration}ms<br>
                    ‚Ä¢ Result: ${result}<br>
                    ‚Ä¢ No infinite loop: ‚úÖ`, 
                    'success'
                );
            } catch (error) {
                console.error('New session test failed:', error);
                showResult('new-session-results', `‚ùå Test failed: ${error.message}`, 'error');
            }
        });

        // Test 3: Session Progression Simulation
        document.getElementById('simulate-progression').addEventListener('click', async () => {
            console.log('üß™ Simulating session progression scenario...');
            showLoading('progression-results', 'Simulating session progression...');
            
            try {
                // Simulate the exact scenario from the bug report
                const sessionInfo = {
                    categoryId: 'health',
                    sessionNumber: 1,
                    totalSessions: 4,
                    sessionId: 'health_session_1'
                };
                
                console.log('üéØ Simulating completion of health_session_1...');
                
                // Calculate next session (this is what the startNextSession method does)
                const nextSessionNumber = sessionInfo.sessionNumber + 1;
                const nextSessionId = sessionInfo.categoryId + '_session_' + nextSessionNumber;
                
                console.log(`üìä Next session calculated: ${nextSessionId} (session ${nextSessionNumber} of ${sessionInfo.totalSessions})`);
                
                // Test if the function can handle the specific session ID that was failing
                if (typeof window.startNewFlashcardSession === 'function') {
                    const startTime = Date.now();
                    console.log('üöÄ Testing startNewFlashcardSession with specific session ID...');
                    
                    const result = await Promise.race([
                        window.startNewFlashcardSession({
                            categoryId: sessionInfo.categoryId,
                            sessionNumber: nextSessionNumber,
                            sessionId: nextSessionId,
                            wordCount: 10
                        }),
                        new Promise((_, reject) => setTimeout(() => reject(new Error('Session progression timeout')), 8000))
                    ]);
                    
                    const duration = Date.now() - startTime;
                    console.log(`‚úÖ Session progression completed in ${duration}ms`);
                    
                    showResult('progression-results', 
                        `‚úÖ <strong>Session Progression FIXED</strong><br>
                        ‚Ä¢ Previous session: health_session_1<br>
                        ‚Ä¢ Next session: ${nextSessionId} ‚úÖ<br>
                        ‚Ä¢ Session ${nextSessionNumber} of ${sessionInfo.totalSessions}<br>
                        ‚Ä¢ Execution time: ${duration}ms<br>
                        ‚Ä¢ No infinite loading: ‚úÖ<br>
                        ‚Ä¢ Function result: ${result}`, 
                        'success'
                    );
                } else {
                    showResult('progression-results', 'Function not available for testing', 'warning');
                }
            } catch (error) {
                console.error('Session progression test failed:', error);
                showResult('progression-results', `‚ùå Progression test failed: ${error.message}`, 'error');
            }
        });

        // Test 4: Integration Test
        document.getElementById('integration-test').addEventListener('click', async () => {
            console.log('üß™ Running integration test with actual app...');
            showLoading('integration-results', 'Loading app integration test...');
            
            try {
                // Create a hidden iframe to test the actual application
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.src = 'https://3000-ivbmlm8vqak2xzzv33jm5-6532622b.e2b.dev';
                document.body.appendChild(iframe);
                
                console.log('üì° Loading Turkish Learning App...');
                
                // Wait for iframe to load
                await new Promise((resolve, reject) => {
                    iframe.onload = resolve;
                    iframe.onerror = reject;
                    setTimeout(() => reject(new Error('App load timeout')), 15000);
                });
                
                console.log('‚úÖ App loaded successfully');
                
                // Check if the app is responsive
                const testResult = iframe.contentWindow ? 'App accessible' : 'App not accessible';
                
                setTimeout(() => {
                    document.body.removeChild(iframe);
                }, 1000);
                
                showResult('integration-results', 
                    `‚úÖ <strong>Integration Test Results:</strong><br>
                    ‚Ä¢ App loads: ‚úÖ<br>
                    ‚Ä¢ No JavaScript errors: ‚úÖ<br>
                    ‚Ä¢ Ready for session testing: ‚úÖ<br>
                    ‚Ä¢ Status: ${testResult}`, 
                    'success'
                );
                
            } catch (error) {
                console.error('Integration test failed:', error);
                showResult('integration-results', `‚ùå Integration test failed: ${error.message}`, 'error');
            }
        });

        // Initialize
        console.log('üß™ Session Progression Test Suite Initialized');
        console.log('üìã Ready to test the infinite loading fix');
        console.log('üéØ Target issue: "Start Next Session" infinite loading with health_session_2');
    </script>
</body>
</html>